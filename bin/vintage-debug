#!/usr/bin/env ruby

require "csv"
require "set"

require_relative "../lib/vintage/config"

module Vintage
  class Disassembler
    def initialize(file)
      @bytes      = File.binread(file).bytes
      @pc         = 0x0600
      @operations = Set.new
      @modes      = Set.new
      @codes      = Vintage::Config.new("6502").codes
    end

    def display_source
      loop do
        @ins_codes = [@bytes.next]

        instruction, mode = @codes[@ins_codes.first]
        arg = argument(mode)

        @operations << instruction
        @modes      << mode

        puts ["%.4x:" % @pc, @ins_codes.map { |e| '%.2x' %  e }.join(" ").ljust(8) + "  ", instruction, arg].join(" ")
        @pc += 1
      end

      puts "\n\nOPERATIONS USED:"
      puts @operations.sort.join(" ")

      puts "\nADDRESSING MODES USED:"
      puts @modes.sort.join(" ")
    end

    def argument(mode)
      case mode
      when "#"
        ""
      when "@"
        "@" + int8
      when "IM"
        '#$' + int8
      when "ZP"
        '$' + int8
      when "ZX"
        '$' + int8 + ",X"
      when "IX"
        '($' + int8 + ',X)' 
      when "IY"
        '($' + int8 + '),Y'
      when "AB"
        "$" + int16
      when "AY"
        "$" + int16 + ",Y"
      end
    end

    def int8
      @pc += 1
      @ins_codes << @bytes.next
      '%.2x' % @ins_codes.last
    end

    def int16
      [int8, int8].reverse.join
    end

    def load_codes(file)
      @codes = Hash[CSV.read(file)
                       .map { |r| [Integer(r[0], 16), [r[1].to_sym, r[2]]] }]
    end
  end
end

Vintage::Disassembler.new(ARGV[0]).display_source
